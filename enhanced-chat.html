<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat AI Ph√°p l√Ω N√¢ng cao - ViLaw</title>
    <meta name="description" content="Tr·ª£ l√Ω AI ph√°p l√Ω th√¥ng minh v·ªõi kh·∫£ nƒÉng h·ªçc h·ªèi v√† c·∫≠p nh·∫≠t li√™n t·ª•c v·ªÅ lu·∫≠t ph√°p Vi·ªát Nam">
    
    <!-- CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- ViLaw Core Scripts -->
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script src="legal-data.js"></script>
    <script src="ai-chat.js"></script>
    <script src="payment.js"></script>
    <script src="ai-learning.js"></script>
    
    <style>
        /* CSS Variables */
        :root {
            --primary: #76BA53;
            --accent: #76819B;
            --dark: #19253F;
            --muted: #9B9CAA;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --primary-rgba-08: rgba(118, 186, 83, 0.08);
            --accent-rgba-08: rgba(118, 129, 155, 0.08);
            --primary-rgba-18: rgba(118, 186, 83, 0.18);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-family: 'Inter', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .tagline {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .ai-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ai-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Chat Interface */
        .chat-interface {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            height: 80vh;
        }

        /* Chat Container */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        /* Chat Header */
        .chat-header {
            background: linear-gradient(135deg, var(--primary), #68a547);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ai-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .ai-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .ai-features {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        .feature-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8fafc;
            color: #1e293b;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary);
            color: white;
        }

        .message.ai .message-avatar {
            background: var(--info);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            position: relative;
        }

        .message.user .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.ai .message-content {
            background: white;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: 70%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Input Container */
        .input-container {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(118, 186, 83, 0.1);
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .action-btn:hover {
            background: #68a547;
            transform: scale(1.05);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.recording {
            background: var(--error);
            animation: pulse 1s infinite;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Quick Actions */
        .quick-actions {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .action-grid {
            display: grid;
            gap: 0.75rem;
        }

        .action-btn-large {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .action-btn-large:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .action-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .action-text {
            flex: 1;
        }

        .action-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .action-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Legal Categories */
        .legal-categories {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .category-btn {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .category-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* AI Learning Status */
        .ai-learning {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .learning-stats {
            display: grid;
            gap: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stat-value {
            font-weight: bold;
            color: var(--primary);
        }

        .learning-progress {
            margin-top: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Suggestions */
        .suggestions {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .suggestion-list {
            display: grid;
            gap: 0.5rem;
        }

        .suggestion-item {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background: var(--primary);
            transform: translateX(5px);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .chat-interface {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .sidebar {
                order: -1;
            }
            
            .category-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .chat-interface {
                height: 70vh;
            }
            
            .category-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .message-content {
                max-width: 85%;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--muted);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">ViLaw AI</div>
            <div class="tagline">Tr·ª£ l√Ω ph√°p l√Ω AI th√¥ng minh</div>
            <div class="ai-status">
                <span>ƒêang ho·∫°t ƒë·ªông</span>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div class="chat-interface">
            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="ai-avatar">ü§ñ</div>
                    <div class="ai-info">
                        <h3>Tr·ª£ l√Ω AI ViLaw</h3>
                        <p>Chuy√™n gia ph√°p l√Ω AI ‚Ä¢ H·ªçc li√™n t·ª•c</p>
                    </div>
                    <div class="ai-features">
                        <span class="feature-badge">24/7</span>
                        <span class="feature-badge">C·∫≠p nh·∫≠t</span>
                        <span class="feature-badge">Th√¥ng minh</span>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome Message -->
                    <div class="message ai fade-in">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <p>Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ph√°p l√Ω AI c·ªßa ViLaw. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                <li>T∆∞ v·∫•n ph√°p lu·∫≠t mi·ªÖn ph√≠</li>
                                <li>So·∫°n th·∫£o h·ª£p ƒë·ªìng</li>
                                <li>Ph√¢n t√≠ch r·ªßi ro ph√°p l√Ω</li>
                                <li>T√¨m ki·∫øm vƒÉn b·∫£n ph√°p lu·∫≠t</li>
                            </ul>
                            <p style="margin-top: 0.5rem;">H√£y cho t√¥i bi·∫øt b·∫°n c·∫ßn h·ªó tr·ª£ g√¨!</p>
                            <div class="message-time">B√¢y gi·ªù</div>
                        </div>
                    </div>
                </div>

                <!-- Input Container -->
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            class="message-input" 
                            placeholder="Nh·∫≠p c√¢u h·ªèi ph√°p l√Ω c·ªßa b·∫°n..."
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <button class="action-btn" id="recordBtn" title="Ghi √¢m">
                                üé§
                            </button>
                            <button class="action-btn" id="sendBtn" title="G·ª≠i tin nh·∫Øn">
                                ‚û§
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 class="section-title">H√†nh ƒë·ªông nhanh</h3>
                    <div class="action-grid">
                        <button class="action-btn-large" onclick="askQuestion('Lu·∫≠t doanh nghi·ªáp quy ƒë·ªãnh g√¨?')">
                            <div class="action-icon">üè¢</div>
                            <div class="action-text">
                                <div class="action-title">Lu·∫≠t doanh nghi·ªáp</div>
                                <div class="action-desc">T∆∞ v·∫•n v·ªÅ doanh nghi·ªáp</div>
                            </div>
                        </button>
                        <button class="action-btn-large" onclick="askQuestion('H·ª£p ƒë·ªìng lao ƒë·ªông c·∫ßn c√≥ g√¨?')">
                            <div class="action-icon">üë∑</div>
                            <div class="action-text">
                                <div class="action-title">H·ª£p ƒë·ªìng lao ƒë·ªông</div>
                                <div class="action-desc">So·∫°n th·∫£o h·ª£p ƒë·ªìng</div>
                            </div>
                        </button>
                        <button class="action-btn-large" onclick="askQuestion('Quy·ªÅn s·ªü h·ªØu t√†i s·∫£n nh∆∞ th·∫ø n√†o?')">
                            <div class="action-icon">üè†</div>
                            <div class="action-text">
                                <div class="action-title">Quy·ªÅn s·ªü h·ªØu</div>
                                <div class="action-desc">T∆∞ v·∫•n v·ªÅ t√†i s·∫£n</div>
                            </div>
                        </button>
                        <button class="action-btn-large" onclick="askQuestion('Lu·∫≠t giao th√¥ng m·ªõi nh·∫•t?')">
                            <div class="action-icon">üöó</div>
                            <div class="action-text">
                                <div class="action-title">Lu·∫≠t giao th√¥ng</div>
                                <div class="action-desc">Quy ƒë·ªãnh giao th√¥ng</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Legal Categories -->
                <div class="legal-categories">
                    <h3 class="section-title">Ch·ªß ƒë·ªÅ ph√°p lu·∫≠t</h3>
                    <div class="category-grid">
                        <button class="category-btn" onclick="askQuestion('Hi·∫øn ph√°p Vi·ªát Nam quy ƒë·ªãnh g√¨?')">Hi·∫øn ph√°p</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t d√¢n s·ª± v·ªÅ g√¨?')">D√¢n s·ª±</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t h√¨nh s·ª± quy ƒë·ªãnh g√¨?')">H√¨nh s·ª±</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t lao ƒë·ªông nh∆∞ th·∫ø n√†o?')">Lao ƒë·ªông</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t thu·∫ø quy ƒë·ªãnh g√¨?')">Thu·∫ø</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t ƒë·∫•t ƒëai nh∆∞ th·∫ø n√†o?')">ƒê·∫•t ƒëai</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t h√¥n nh√¢n gia ƒë√¨nh?')">Gia ƒë√¨nh</button>
                        <button class="category-btn" onclick="askQuestion('Lu·∫≠t an ninh m·∫°ng?')">An ninh m·∫°ng</button>
                    </div>
                </div>

                <!-- AI Learning Status -->
                <div class="ai-learning">
                    <h3 class="section-title">Tr·∫°ng th√°i AI</h3>
                    <div class="learning-stats">
                        <div class="stat-item">
                            <span class="stat-label">Ki·∫øn th·ª©c ph√°p lu·∫≠t</span>
                            <span class="stat-value" id="knowledgeLevel">95%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ƒê·ªô ch√≠nh x√°c</span>
                            <span class="stat-value" id="accuracyLevel">98%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">C·∫≠p nh·∫≠t cu·ªëi</span>
                            <span class="stat-value" id="lastUpdate">H√¥m nay</span>
                        </div>
                    </div>
                    <div class="learning-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 95%"></div>
                        </div>
                        <p style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">AI ƒëang h·ªçc h·ªèi li√™n t·ª•c</p>
                    </div>
                </div>

                <!-- Suggestions -->
                <div class="suggestions">
                    <h3 class="section-title">G·ª£i √Ω c√¢u h·ªèi</h3>
                    <div class="suggestion-list" id="suggestionsList">
                        <button class="suggestion-item" onclick="askQuestion('T√¥i mu·ªën th√†nh l·∫≠p c√¥ng ty c·∫ßn l√†m g√¨?')">
                            Th√†nh l·∫≠p c√¥ng ty
                        </button>
                        <button class="suggestion-item" onclick="askQuestion('H·ª£p ƒë·ªìng mua b√°n nh√† c·∫ßn c√≥ g√¨?')">
                            H·ª£p ƒë·ªìng mua b√°n nh√†
                        </button>
                        <button class="suggestion-item" onclick="askQuestion('Quy·ªÅn l·ª£i ng∆∞·ªùi lao ƒë·ªông?')">
                            Quy·ªÅn l·ª£i lao ƒë·ªông
                        </button>
                        <button class="suggestion-item" onclick="askQuestion('X·ª≠ ph·∫°t vi ph·∫°m giao th√¥ng?')">
                            X·ª≠ ph·∫°t giao th√¥ng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Initialize enhanced chat
            initializeEnhancedChat();
        });

        let chatApp;
        let isRecording = false;
        let recognition;

        function initializeEnhancedChat() {
            console.log('Initializing Enhanced Chat...');
            
            // Initialize chat app
            if (window.aiChatSystem) {
                chatApp = window.aiChatSystem;
            } else {
                chatApp = new AIChatSystem();
            }
            
            // Initialize AI learning system
            if (window.aiLearningSystem) {
                console.log('AI Learning System available');
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize speech recognition
            initializeSpeechRecognition();
            
            // Update AI learning status
            updateAILearningStatus();
            
            // Start learning monitoring
            startLearningMonitoring();
            
            console.log('Enhanced Chat initialized successfully');
        }

        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const recordBtn = document.getElementById('recordBtn');
            
            // Send button
            sendBtn.addEventListener('click', sendMessage);
            
            // Record button
            recordBtn.addEventListener('click', toggleRecording);
            
            // Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Enable/disable send button
                sendBtn.disabled = !this.value.trim();
            });
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'vi-VN';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                    sendMessage();
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    showMessage('Kh√¥ng th·ªÉ nh·∫≠n di·ªán gi·ªçng n√≥i', 'error');
                };
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            // Add user message
            addMessage('user', content);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            document.getElementById('sendBtn').disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            // Generate AI response
            generateAIResponse(content);
        }

        function askQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} fade-in`;
            
            const avatar = type === 'user' ? 'üë§' : 'ü§ñ';
            const time = new Date().toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <p>${content}</p>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="typing-indicator">
                    <span>AI ƒëang suy nghƒ©</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function generateAIResponse(userInput) {
            const startTime = Date.now();
            
            try {
                // Simulate AI processing time
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                // Generate response using AI system
                let response;
                if (chatApp && chatApp.sendMessage) {
                    const aiResponse = await chatApp.sendMessage(userInput);
                    response = aiResponse.content;
                } else {
                    response = generateFallbackResponse(userInput);
                }
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add AI response
                addMessage('ai', response);
                
                // Track interaction for learning
                const responseTime = Date.now() - startTime;
                if (window.aiLearningSystem) {
                    window.aiLearningSystem.trackUserInteraction(
                        userInput, 
                        response, 
                        null, // rating will be set later
                        responseTime
                    );
                }
                
                // Update AI learning status
                updateAILearningStatus();
                
                // Add rating buttons
                addRatingButtons(userInput, response);
                
            } catch (error) {
                console.error('Error generating AI response:', error);
                hideTypingIndicator();
                addMessage('ai', 'Xin l·ªói, t√¥i g·∫∑p s·ª± c·ªë khi x·ª≠ l√Ω c√¢u h·ªèi c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }
        
        function addRatingButtons(question, answer) {
            // Add rating buttons to the last AI message
            const messagesContainer = document.getElementById('messagesContainer');
            const lastMessage = messagesContainer.lastElementChild;
            
            if (lastMessage && lastMessage.classList.contains('ai')) {
                const ratingContainer = document.createElement('div');
                ratingContainer.className = 'rating-container';
                ratingContainer.style.cssText = `
                    margin-top: 0.5rem;
                    display: flex;
                    gap: 0.5rem;
                    align-items: center;
                `;
                
                ratingContainer.innerHTML = `
                    <span style="font-size: 0.8rem; opacity: 0.7;">ƒê√°nh gi√° c√¢u tr·∫£ l·ªùi:</span>
                    <div style="display: flex; gap: 0.25rem;">
                        ${[1, 2, 3, 4, 5].map(rating => `
                            <button class="rating-btn" data-rating="${rating}" style="
                                background: none;
                                border: 1px solid #e2e8f0;
                                border-radius: 4px;
                                padding: 0.25rem 0.5rem;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">‚≠ê</button>
                        `).join('')}
                    </div>
                `;
                
                lastMessage.querySelector('.message-content').appendChild(ratingContainer);
                
                // Add rating event listeners
                ratingContainer.querySelectorAll('.rating-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const rating = parseInt(this.dataset.rating);
                        rateResponse(question, answer, rating);
                        
                        // Update button appearance
                        ratingContainer.querySelectorAll('.rating-btn').forEach(b => {
                            b.style.background = 'none';
                            b.style.color = '#666';
                        });
                        
                        for (let i = 1; i <= rating; i++) {
                            const btn = ratingContainer.querySelector(`[data-rating="${i}"]`);
                            btn.style.background = 'var(--primary)';
                            btn.style.color = 'white';
                        }
                    });
                });
            }
        }
        
        function rateResponse(question, answer, rating) {
            // Rate the AI response
            if (window.aiLearningSystem) {
                // Find the interaction and update rating
                const interactions = window.aiLearningSystem.userInteractions;
                const lastInteraction = interactions[interactions.length - 1];
                
                if (lastInteraction && lastInteraction.question === question) {
                    window.aiLearningSystem.updateInteractionRating(lastInteraction.id, rating);
                }
            }
            
            showMessage(`C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√° ${rating} sao!`, 'success');
        }

        function generateFallbackResponse(userInput) {
            const responses = {
                'lu·∫≠t doanh nghi·ªáp': 'Lu·∫≠t Doanh nghi·ªáp 2020 quy ƒë·ªãnh v·ªÅ vi·ªác th√†nh l·∫≠p, qu·∫£n l√Ω, t·ªï ch·ª©c l·∫°i, gi·∫£i th·ªÉ doanh nghi·ªáp. C√°c lo·∫°i h√¨nh doanh nghi·ªáp bao g·ªìm: c√¥ng ty TNHH, c√¥ng ty c·ªï ph·∫ßn, doanh nghi·ªáp t∆∞ nh√¢n, c√¥ng ty h·ª£p danh.',
                'h·ª£p ƒë·ªìng lao ƒë·ªông': 'H·ª£p ƒë·ªìng lao ƒë·ªông c·∫ßn c√≥ c√°c n·ªôi dung: t√™n v√† ƒë·ªãa ch·ªâ ng∆∞·ªùi s·ª≠ d·ª•ng lao ƒë·ªông, h·ªç t√™n, ng√†y th√°ng nƒÉm sinh, gi·ªõi t√≠nh, ƒë·ªãa ch·ªâ th∆∞·ªùng tr√∫, s·ªë CMND/CCCD c·ªßa ng∆∞·ªùi lao ƒë·ªông, c√¥ng vi·ªác v√† ƒë·ªãa ƒëi·ªÉm l√†m vi·ªác, th·ªùi h·∫°n h·ª£p ƒë·ªìng, m·ª©c l∆∞∆°ng, th·ªùi gian l√†m vi·ªác, th·ªùi gian ngh·ªâ ng∆°i.',
                'quy·ªÅn s·ªü h·ªØu': 'Quy·ªÅn s·ªü h·ªØu bao g·ªìm quy·ªÅn chi·∫øm h·ªØu, quy·ªÅn s·ª≠ d·ª•ng v√† quy·ªÅn ƒë·ªãnh ƒëo·∫°t t√†i s·∫£n. Ch·ªß s·ªü h·ªØu c√≥ quy·ªÅn s·ª≠ d·ª•ng t√†i s·∫£n theo √Ω ch√≠ c·ªßa m√¨nh nh∆∞ng kh√¥ng ƒë∆∞·ª£c tr√°i ph√°p lu·∫≠t, ƒë·∫°o ƒë·ª©c x√£ h·ªôi.',
                'lu·∫≠t giao th√¥ng': 'Lu·∫≠t Giao th√¥ng ƒë∆∞·ªùng b·ªô quy ƒë·ªãnh v·ªÅ quy t·∫Øc giao th√¥ng, ƒëi·ªÅu ki·ªán tham gia giao th√¥ng c·ªßa ph∆∞∆°ng ti·ªán, quy·ªÅn v√† nghƒ©a v·ª• c·ªßa ng∆∞·ªùi tham gia giao th√¥ng, x·ª≠ ph·∫°t vi ph·∫°m h√†nh ch√≠nh trong lƒ©nh v·ª±c giao th√¥ng ƒë∆∞·ªùng b·ªô.'
            };
            
            const input = userInput.toLowerCase();
            for (const [keyword, response] of Object.entries(responses)) {
                if (input.includes(keyword)) {
                    return response;
                }
            }
            
            return 'T√¥i hi·ªÉu c√¢u h·ªèi c·ªßa b·∫°n v·ªÅ ph√°p lu·∫≠t. ƒê·ªÉ c√≥ c√¢u tr·∫£ l·ªùi ch√≠nh x√°c nh·∫•t, t√¥i khuy√™n b·∫°n n√™n tham kh·∫£o lu·∫≠t s∆∞ chuy√™n nghi·ªáp. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu th√™m v·ªÅ c√°c vƒÉn b·∫£n ph√°p lu·∫≠t li√™n quan.';
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            
            if (!recognition) {
                showMessage('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i', 'error');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'üé§';
                isRecording = false;
            } else {
                recognition.start();
                recordBtn.classList.add('recording');
                recordBtn.textContent = '‚èπ';
                isRecording = true;
            }
        }

        function updateAILearningStatus() {
            // Get real learning stats
            let knowledgeLevel = 95;
            let accuracyLevel = 98;
            
            if (window.aiLearningSystem) {
                const stats = window.aiLearningSystem.getLearningStats();
                knowledgeLevel = stats.knowledgeLevel || 95;
                accuracyLevel = stats.accuracy || 98;
            }
            
            document.getElementById('knowledgeLevel').textContent = Math.round(knowledgeLevel) + '%';
            document.getElementById('accuracyLevel').textContent = Math.round(accuracyLevel) + '%';
            
            // Update progress bar
            const progressFill = document.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = knowledgeLevel + '%';
            }
        }
        
        function startLearningMonitoring() {
            // Monitor AI learning progress
            setInterval(() => {
                updateAILearningStatus();
                
                // Update learning stats display
                if (window.aiLearningSystem) {
                    const stats = window.aiLearningSystem.getLearningStats();
                    updateLearningDisplay(stats);
                }
            }, 30000); // Every 30 seconds
        }
        
        function updateLearningDisplay(stats) {
            // Update learning display with real stats
            const lastUpdate = new Date(stats.lastUpdate);
            const timeAgo = getTimeAgo(lastUpdate);
            document.getElementById('lastUpdate').textContent = timeAgo;
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'V·ª´a xong';
            if (minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
            if (hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
            return `${days} ng√†y tr∆∞·ªõc`;
        }

        function showMessage(message, type = 'info') {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') {
                messageDiv.style.background = 'var(--success)';
            } else if (type === 'error') {
                messageDiv.style.background = 'var(--error)';
            } else if (type === 'warning') {
                messageDiv.style.background = 'var(--warning)';
            } else {
                messageDiv.style.background = 'var(--primary)';
            }
            
            document.body.appendChild(messageDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Global functions for testing
        window.testChat = function() {
            console.log('Testing enhanced chat...');
            askQuestion('Lu·∫≠t doanh nghi·ªáp quy ƒë·ªãnh g√¨?');
        };

        window.debugChat = function() {
            console.log('Chat App:', chatApp);
            console.log('Messages container:', document.getElementById('messagesContainer'));
            console.log('Message input:', document.getElementById('messageInput'));
            console.log('Send button:', document.getElementById('sendBtn'));
        };
    </script>
</body>
</html>
